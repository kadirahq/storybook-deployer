#!/usr/bin/env node

var shell = require('shelljs');
var publishUtils = require('../src/utils');
var build = require('../src/build');
var path = require('path');
var packageJson = require(path.resolve('./package.json'));
var argv = require('yargs').argv;

var SKIP_BUILD = Boolean(argv['existing-output-dir'])
var OUTPUT_DIR = argv['existing-output-dir'] || 'out' + Math.ceil(Math.random() * 9999);
var NPM_SCRIPT = argv['script'];

var AWS_PROFILE = argv['aws-profile'] || 'default';
var BUCKET_PATH = argv['bucket-path'];
var S3_PATH = 's3://' + BUCKET_PATH;

if (!BUCKET_PATH) {
  console.log('This command needs a bucket path: "my-bucket-name/path/to/destination-folder-in-bucket"');
  process.exit(-1);
}

build(SKIP_BUILD, OUTPUT_DIR, packageJson, NPM_SCRIPT);

console.log('=> Deploying storybook');
publishUtils.exec(`aws --profile ${AWS_PROFILE} s3 sync ${OUTPUT_DIR} ${S3_PATH}`);

shell.rm('-rf', OUTPUT_DIR);

console.log('=> Storybook deployed to: ${S3_PATH}');
